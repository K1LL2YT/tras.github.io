<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KLZ Aced Tournament</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      background: #0d0d0d;
      color: #eee;
      min-height: 100vh;
      padding-bottom: 2rem;
    }
    h1 {
      margin-top: 1rem;
      font-weight: 900;
      color: #ffb400;
      text-shadow: 0 0 6px #ffb400aa;
    }
    p.lead {
      font-size: 1.15rem;
      color: #ccc;
    }
    .nav-tabs .nav-link.active {
      background-color: #1f1f1f;
      border-color: #444 #444 #0d0d0d;
      color: #ffb400;
      font-weight: 700;
    }
    .nav-tabs .nav-link {
      color: #bbb;
      font-weight: 600;
      transition: color 0.3s;
    }
    .nav-tabs .nav-link:hover {
      color: #ffb400;
    }
    .tab-content > div {
      margin-top: 2rem;
    }
    table {
      background: #121212;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 12px #ffb400aa;
    }
    thead tr {
      background: #222;
      color: #ffb400;
      font-weight: 700;
    }
    tbody tr {
      transition: background-color 0.2s ease;
      cursor: default;
    }
    tbody tr:hover {
      background-color: #333333aa;
    }
    tbody td, thead th {
      vertical-align: middle !important;
    }
    img.avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 0.75rem;
      vertical-align: middle;
      border: 2px solid #ffb400;
      transition: transform 0.3s ease;
    }
    img.avatar:hover {
      transform: scale(1.1);
      border-color: #fff;
    }
    .rank-badge {
      font-size: 1.3rem;
      vertical-align: middle;
      margin-left: 6px;
    }
    /* Rank colors */
    .rank-1 { color: #ffd700; } /* Gold */
    .rank-2 { color: #c0c0c0; } /* Silver */
    .rank-3 { color: #cd7f32; } /* Bronze */

    /* Responsive tweaks */
    @media (max-width: 575.98px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        display: none;
      }
      tbody tr {
        margin-bottom: 1rem;
        background: #222;
        border-radius: 8px;
        padding: 1rem;
      }
      tbody td {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
      }
      tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #ffb400;
      }
      img.avatar {
        margin-right: 0.5rem;
      }
    }
  </style>
</head>
<body class="container py-4">

  <h1><i class="bi bi-controller"></i> KLZ Aced Tournament</h1>
  <p class="lead">Fun. Competitive. Chaotic. Open to all players. Hosted by RobloxKLZ.</p>

  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="bracket-tab" data-bs-toggle="tab" data-bs-target="#bracket" type="button" role="tab">üèÜ Bracket</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="leaderboard-tab" data-bs-toggle="tab" data-bs-target="#leaderboard" type="button" role="tab">üìä Leaderboard</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="games-tab" data-bs-toggle="tab" data-bs-target="#games" type="button" role="tab">üïπÔ∏è Games</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">üóìÔ∏è Schedule</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="bracket" role="tabpanel" aria-labelledby="bracket-tab">
      <h3>üèÜ Current Bracket</h3>
      <p>Embed or update bracket manually here (e.g. Challonge embed).</p>
    </div>

    <div class="tab-pane fade" id="leaderboard" role="tabpanel" aria-labelledby="leaderboard-tab">
      <h3>üìä Elo Leaderboard</h3>
      <p>Live rankings pulled from Google Sheets.</p>

      <table class="table table-dark table-hover align-middle" id="leaderboard-table" style="max-width: 700px; margin:auto; border-radius: 8px; overflow:hidden;">
        <thead>
          <tr>
            <th>#</th>
            <th>Player</th>
            <th>Game Wins</th>
            <th>Tourney Wins</th>
            <th>Placements</th>
            <th>Losses</th>
            <th>Elo</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will inject rows here -->
        </tbody>
      </table>
    </div>

    <div class="tab-pane fade" id="games" role="tabpanel" aria-labelledby="games-tab">
      <h3>üïπÔ∏è Game Roster</h3>
      <p>List of games played in the tournament.</p>
    </div>

    <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
      <h3>üóìÔ∏è Stream Schedule</h3>
      <p>Upcoming matches, stream times, and Twitch link.</p>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2_wr_BqYz609qT5ajqqg7Dc9GIg0Y1fC9u26LnDWFuZbs_ItQfiRigpXkywopq5K4LuSRR25FaBAw/pub?output=csv";

    // Helper: get numeric userId from Roblox username via API
    async function getUserId(username) {
      try {
        const response = await fetch(`https://api.roblox.com/users/get-by-username?username=${encodeURIComponent(username)}`);
        if (!response.ok) return null;
        const data = await response.json();
        return data && data.Id ? data.Id : null;
      } catch {
        return null;
      }
    }

    async function loadLeaderboard() {
      try {
        const response = await fetch(sheetURL);
        const csvText = await response.text();

        const rows = csvText.trim().split("\n");
        const headers = rows[0].split(",");
        const dataRows = rows.slice(1);

        const playersRaw = dataRows.map(row => {
          const cols = row.split(",");
          return {
            Player: cols[0],
            RobloxUser: cols[1],
            GameWins: parseInt(cols[2]) || 0,
            TourneyWins: parseInt(cols[3]) || 0,
            Placements: parseInt(cols[4]) || 0,
            Losses: parseInt(cols[5]) || 0,
            Elo: cols[6] ? parseInt(cols[6]) : 0,
          };
        });

        // Cache for username->userId to avoid duplicate API calls
        const userIdCache = {};

        async function resolveUserId(nameOrId) {
          if (!nameOrId) return 0;
          if (!isNaN(Number(nameOrId))) return Number(nameOrId); // Already numeric userId
          if (userIdCache[nameOrId]) return userIdCache[nameOrId]; // Cached
          const id = await getUserId(nameOrId);
          if (id) userIdCache[nameOrId] = id;
          else userIdCache[nameOrId] = 0; // fallback zero id to avoid retry
          return userIdCache[nameOrId];
        }

        // Resolve user IDs for all players
        const players = [];
        for (const p of playersRaw) {
          const numericId = await resolveUserId(p.RobloxUser);
          players.push({...p, numericUserId: numericId});
        }

        // Calculate Elo if missing
        players.forEach(p => {
          if (p.Elo === 0) {
            p.Elo = (p.GameWins * 10) + (p.TourneyWins * 25) + (p.Placements * 15) - (p.Losses * 5);
          }
        });

        // Sort descending Elo
        players.sort((a, b) => b.Elo - a.Elo);

        const tbody = document.querySelector("#leaderboard-table tbody");
        tbody.innerHTML = "";

        players.forEach((p, i) => {
          let medal = "";
          let rankClass = "";
          if (i === 0) { medal = "bi-award-fill"; rankClass = "rank-1"; }
          else if (i === 1) { medal = "bi-award"; rankClass = "rank-2"; }
          else if (i === 2) { medal = "bi-award"; rankClass = "rank-3"; }

          const avatarURL = `https://www.roblox.com/headshot-thumbnail/image?userId=${p.numericUserId}&width=48&height=48&format=png`;
          const profileURL = `https://www.roblox.com/users/${p.numericUserId}/profile`;

          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>
              ${i + 1}
              ${medal ? `<i class="bi ${medal} rank-badge ${rankClass}" title="Rank ${i + 1}"></i>` : ''}
            </td>
            <td data-label="Player">
              <img class="avatar" src="${avatarURL}" alt="avatar" onerror="this.onerror=null;this.src='https://tr.rbxcdn.com/0f20f6c9b35f21575b2e260a16e87ed0';" />
              <a href="${profileURL}" target="_blank" rel="noopener noreferrer" class="text-warning text-decoration-none fw-semibold">${p.Player}</a>
            </td>
            <td data-label="Game Wins">${p.GameWins}</td>
            <td data-label="Tourney Wins">${p.TourneyWins}</td>
            <td data-label="Placements">${p.Placements}</td>
            <td data-label="Losses">${p.Losses}</td>
            <td data-label="Elo"><strong>${p.Elo}</strong></td>
          `;

          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading leaderboard:", err);
      }
    }

    loadLeaderboard();
  </script>
</body>
</html>
